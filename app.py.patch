--- /mnt/data/_orig/Gestion-Cuisine/app.py	2026-02-01 10:44:54.000000000 +0000
+++ /mnt/data/_mod2/Gestion-Cuisine/app.py	2026-02-01 17:58:52.000000000 +0000
@@ -21,6 +21,7 @@
 import pandas as pd
 import datetime as dt
 import importlib
+import re
 
 
 # -----------------------------
@@ -62,6 +63,10 @@
         billing = importlib.import_module("src.billing")
         importlib.reload(billing)
 
+        # Import Facturation PDJ
+        pdj_factu = importlib.import_module("src.pdj_facturation")
+        importlib.reload(pdj_factu)
+
         # Import allerg√®nes
         learner = importlib.import_module("src.allergens.learner")
         importlib.reload(learner)
@@ -69,7 +74,7 @@
         generator = importlib.import_module("src.allergens.generator")
         importlib.reload(generator)
 
-        return processor, cs, order_forms, billing, learner, generator
+        return processor, cs, order_forms, billing, pdj_factu, learner, generator
 
     except Exception as e:
         st.error("üí• Erreur lors d‚Äôun import (module src.*)")
@@ -78,7 +83,7 @@
         st.stop()
 
 
-processor, cs, order_forms, billing, learner, generator = _import_or_stop()
+processor, cs, order_forms, billing, pdj_factu, learner, generator = _import_or_stop()
 
 # Exports processor
 parse_planning_fabrication = processor.parse_planning_fabrication
@@ -105,6 +110,10 @@
 export_monthly_workbook = billing.export_monthly_workbook
 apply_corrected_monthly_workbook = billing.apply_corrected_monthly_workbook
 
+# Facturation PDJ
+parse_pdj_order_file = pdj_factu.parse_pdj_order_file
+update_facturation_economat = pdj_factu.update_facturation_economat
+
 # allerg√®nes
 learn_from_filled_allergen_workbook = learner.learn_from_filled_allergen_workbook
 generate_allergen_workbook = generator.generate_allergen_workbook
@@ -649,6 +658,99 @@
                     st.error("Impossible d'importer ce fichier. Il doit provenir de l'export de l'app.")
                     st.code(repr(e))
 
+        # -------------------------------------------------
+        # Facturation PDJ (Economat)
+        # -------------------------------------------------
+        st.divider()
+        st.markdown("### Facturation PDJ (√©conomat)")
+        st.caption(
+            "Ajoute un ou plusieurs bons de commande (PDF scann√© ou Excel) : l'app remplit automatiquement le fichier "
+            "de facturation √©conomat (quantit√©s par site + produit)."
+        )
+
+        economat_tpl = st.file_uploader(
+            "Mod√®le 'Facturation √©conomat' (.xlsx)",
+            type=["xlsx"],
+            key="economat_template",
+        )
+        pdj_files = st.file_uploader(
+            "Bons de commande PDJ (PDF/Excel) ‚Äî plusieurs fichiers",
+            type=["pdf", "xls", "xlsx", "xlsm"],
+            accept_multiple_files=True,
+            key="pdj_orders",
+        )
+        force_month = st.text_input(
+            "Mois √† √©crire dans le mod√®le (optionnel, format YYYY-MM)",
+            value="",
+            key="pdj_month",
+        )
+
+        if st.button("G√©n√©rer Facturation √©conomat (PDJ)", key="gen_economat_pdj", type="primary"):
+            if not economat_tpl:
+                st.error("Ajoute d'abord le fichier 'Facturation √©conomat' (.xlsx).")
+            elif not pdj_files:
+                st.error("Ajoute au moins 1 bon de commande PDJ (PDF/Excel).")
+            else:
+                try:
+                    all_lines = []
+                    months = []
+                    detected = []  # (filename, site)
+
+                    def _infer_site_from_filename(name: str) -> str:
+                        n = (name or "").lower()
+                        if "lautrec" in n or n.startswith("mas") or " mas" in n:
+                            return "MAS"
+                        if "internat" in n or "24" in n or "24t" in n or "24 ter" in n or "24ter" in n:
+                            return "Internat"
+                        return ""
+
+                    def _valid_yyyymm(s: str) -> bool:
+                        s = (s or "").strip()
+                        return bool(re.fullmatch(r"\d{4}-(0[1-9]|1[0-2])", s))
+
+                    if force_month.strip() and not _valid_yyyymm(force_month.strip()):
+                        st.error("Le mois doit √™tre au format YYYY-MM (ex: 2026-01).")
+                        st.stop()
+
+                    for up in pdj_files:
+                        tmp = _save_uploaded_file(up, suffix=Path(getattr(up, "name", "")).suffix or ".pdf")
+                        _site, lines, m = parse_pdj_order_file(tmp)
+
+                        # Si le site n'a pas √©t√© trouv√© dans le document, on tente le nom de fichier.
+                        if not (_site or "").strip():
+                            _site = _infer_site_from_filename(getattr(up, "name", ""))
+                            # et on applique au moins au site des lignes
+                            if _site:
+                                for ln in lines:
+                                    ln.site = _site
+
+                        detected.append((getattr(up, "name", "(fichier)"), _site or "(non d√©tect√©)"))
+                        all_lines.extend(lines)
+                        if m:
+                            months.append(m)
+
+                    # Affiche la correspondance fichier -> site d√©tect√©
+                    if detected:
+                        st.markdown("**Site d√©tect√© par bon de commande :**")
+                        for fn, st_site in detected:
+                            st.write(f"- {fn} ‚Üí {st_site}")
+
+                    # Mois choisi : priorit√© √† la saisie utilisateur, sinon premier mois d√©tect√©
+                    fm = force_month.strip() or (months[0] if months else None)
+                    tpl_path = _save_uploaded_file(economat_tpl, suffix=".xlsx")
+                    out_path = update_facturation_economat(tpl_path, all_lines, force_month=fm)
+
+                    with open(out_path, "rb") as f:
+                        st.download_button(
+                            "T√©l√©charger Facturation_economat_PDJ.xlsx",
+                            data=f,
+                            file_name="Facturation_economat_PDJ.xlsx",
+                            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
+                        )
+                except Exception as e:
+                    st.error("Impossible de g√©n√©rer la facturation √©conomat (PDJ).")
+                    st.code(repr(e))
+
     with tab_all:
         st.subheader("Tableaux allerg√®nes (format EXACT)")
         st.caption(
